<?xml version="1.0" encoding="UTF-8" ?>
<!--
This software is in the public domain under CC0 1.0 Universal plus a 
Grant of Patent License.

To the extent possible under law, the author(s) have dedicated all
copyright and related and neighboring rights to this software to the
public domain worldwide. This software is distributed without any
warranty.

You should have received a copy of the CC0 Public Domaicrn Dedication
along with this software (see the LICENSE.md file). If not, see
<http://creativecommons.org/publicdomain/zero/1.0/>.
-->
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-2.1.xsd">

    <service verb="check" noun="Company">
        <in-parameters><parameter name="partyId" required="true"/></in-parameters>
        <out-parameters><parameter name="ok"/></out-parameters>
        <actions>
            <entity-find entity-name="growerp.mobile.CompanyPersonAndLoginGroup"
                    list="parties">
                <econdition field-name="companyPartyId" from="partyId"/>
            </entity-find>
            <if condition="parties">
                <set field="ok" value="ok"/></if>
        </actions>
    </service>

    <service verb="get" noun="Companies">
        <in-parameters>
            <parameter name="partyClassificationId"/>
        </in-parameters>
        <out-parameters>
            <parameter name="companies"/>
        </out-parameters>
        <actions>
            <entity-find entity-name="growerp.mobile.party.CompanyPreferenceAndClassification" list="parties">
                <econdition field-name="partyClassificationId" ignore-if-empty="true"/>
                <econditions combine="or">
                    <econdition field-name="disabled" operator="not-equals" value="Y"/>
                    <econdition field-name="disabled" operator="is-null"/>
                </econditions>
            </entity-find>
            <set field="companies" from="[]" />
            <iterate list="parties" entry="party">
                <service-call name="growerp.100.PartyServices100.get#Company" out-map="context"
                    in-map="[companyPartyId: party.partyId, contentTypeId: 'PcntImageSmall']"/>
                <script>companies.add(company)</script>
            </iterate>
        </actions>
    </service>

    <service verb="get" noun="Company">
        <in-parameters>
            <parameter name="companyPartyId"/>
            <parameter name="contentTypeId" default-value="PcntImageMedium"/>
        </in-parameters>
        <out-parameters>
            <parameter name="company" type="Map"/>
        </out-parameters>
        <actions>
            <if condition="!companyPartyId &amp;&amp; ec.user &amp;&amp; ec.user.userAccount?.partyId">
                <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyPartyId" out-map="context"/>
                <set field="companyPartyId" from="ownerPartyId"/>
            </if>
            <if condition="!companyPartyId"><return/></if><!-- return null if no company found -->
            <entity-find-one entity-name="growerp.mobile.party.CompanyPreferenceAndClassification" value-field="org">
                <field-map field-name="partyId" from="companyPartyId"/></entity-find-one>
            <if condition="!org"><return error="true" message="Company ${companyPartyId} not found!"/></if>
            <service-call name="mantle.party.ContactServices.get#PrimaryEmailAddress"
                in-map="[partyId: companyPartyId]" out-map="context"/>
            <entity-find entity-name="mantle.party.PartyContent" list="contents">
                <econdition field-name="partyId" from="companyPartyId"/>
                <econdition field-name="partyContentTypeEnumId" from="contentTypeId"/>
            </entity-find>
            <if condition="contents">
                <service-call name="growerp.100.ImageServices100.download#Image"
                    in-map="[contentLocation: contents[0].contentLocation]" out-map="context"/>
            </if>
            <set field="company" from="[
                partyId: companyPartyId,
                name: org.organizationName,
                classificationId: org.partyClassificationId,
                classificationDescr: org.description,
                email: emailAddress,
                currencyId: org.baseCurrencyUomId,
                image: imageFile
                ]"/>
        </actions>
    </service>

    <service verb="update" noun="Company">
        <description>
            update company information
        </description>
        <in-parameters>
            <parameter name="company"/>
            <parameter name="base64"/>
        </in-parameters>
        <out-parameters>
            <parameter name="company" type="Map"/>
        </out-parameters>
        <actions>
            <script> // convert JSON data
                Object compIn = new groovy.json.JsonSlurper().parseText(company).company
            </script>
            <!-- check access user belongs to this company override companyPartyId-->
            <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyPartyId"
                out-map="context"/>
            <set field="compIn.partyId" from="ownerPartyId"/>
            <!-- get old values -->
            <service-call name="growerp.100.PartyServices100.get#Company" out-map="oldValue"/>
            <!-- update name -->
            <if condition="compIn.name &amp;&amp; oldValue.company.name !=  compIn.name">
                <service-call name="update#mantle.party.Organization"
                    in-map="[partyId: oldValue.company.partyId, organizationName: compIn.name]"/>
            </if>
            <!-- update email -->
            <if condition="compIn.email &amp;&amp; compIn.email != oldValue.company.email">
                <entity-find entity-name="mantle.party.contact.PartyContactMech" for-update="true" list="partyContactMechs" >
                    <econdition field-name="partyId" from="oldValue.company.partyId"/>
                    <econdition field-name="contactMechPurposeId" value="EmailPrimary"/><date-filter/></entity-find>
                <if condition="partyContactMechs">
                    <set field="partyContactMechs[0].thruDate" from="ec.user.nowTimestamp"/>
                    <entity-update value-field="partyContactMechs[0]"/> </if>
                <service-call name="mantle.party.ContactServices.create#EmailAddress"
                    in-map="[partyId: oldValue.company.partyId, contactMechPurposeId: 'EmailPrimary', emailAddress: compIn.email]"/>
            </if>
            <!-- update currency -->
            <entity-find-one entity-name="mantle.ledger.config.PartyAcctgPreference" value-field="pref" for-update="true">
                <field-map field-name="organizationPartyId" from="compIn.partyId"/>
            </entity-find-one>
            <if condition="pref.baseCurrencyUomId != compIn.currencyId">
                <set field="pref.baseCurrencyUomId" from="compIn.currencyId"/>
                <entity-update value-field="pref" />
            </if>
            <!-- update image -->
            <if condition="base64">
                <service-call name="growerp.100.ImageServices100.upload#Image"
                    in-map="[type: 'user', id: compIn.partyId, base64: base64]"/>
            </if>
            <service-call name="growerp.100.PartyServices100.get#Company" out-map="context"/>
        </actions>
    </service>

    <service verb="get" noun="User">
        <description>
            Get all users of the company or usergroup they belong to(with partyId just a single party with PartyId)
        </description>
        <in-parameters>
            <parameter name="userPartyId"/><!-- if present select a single user, else a list -->
            <parameter name="userGroupId"/><!-- if present select user from particular groups-->
            <parameter name="start" type="Integer" default-value="0"/>
            <parameter name="limit" type="Integer" default-value="20"/>
            <parameter name="filter"/>
            <parameter name="search"/>
        </in-parameters>
        <out-parameters>
            <parameter name="users" type="List"/>
            <parameter name="user" type="Map"/>
        </out-parameters>
        <actions>
            <if condition="filter">
                <set field="filter" value="%${filter}%"/>
            </if>
            <if condition="search">
                <set field="search" value="%${search}%"/></if>
            <service-call out-map="relatedLogin"
                name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner"/>
            <entity-find offset="start" limit="limit" list="userInfos"
                entity-name="growerp.mobile.CompanyPersonAndLoginGroup">
                <econdition field-name="ownerPartyId" from="relatedLogin.ownerPartyId"/>
                <econdition field-name="userPartyId" ignore-if-empty="true"/>
                <econditions combine="or">
                    <econdition field-name="userPartyId" operator="like"
                        from="filter" ignore-if-empty="true"/>
                    <econdition field-name="lastName" operator="like"
                        from="filter" ignore-if-empty="true"/>
                    <econdition field-name="firstName" operator="like"
                        from="filter" ignore-if-empty="true"/>
                    <econdition field-name="companyName" operator="like"
                        from="filter" ignore-if-empty="true"/>
                </econditions>
                <econditions combine="or">
                    <econdition field-name="userPartyId"
                        operator="like" from="search" ignore-if-empty="true"/>
                    <econdition field-name="userFullName"
                        operator="like" from="search" ignore-if-empty="true"/>
                    <econdition field-name="emailAddress"
                        operator="like" from="search" ignore-if-empty="true"/>
                </econditions>
        <econdition field-name="userGroupId" ignore-if-empty="true"/>
                <order-by field-name="lastName"/><order-by field-name="firstName"/>
            </entity-find>
            <if condition="!userPartyId"><set field="users" from="[]"/></if>
            <iterate entry="userInfo" list="userInfos">
                <if condition="filter">
                    <script>
                        users.add([
                            partyId: userInfo?.userPartyId,
                            firstName: userInfo?.firstName,
                            lastName: userInfo?.lastName,
                            companyPartyId: userInfo.companyPartyId,
                            companyName: userInfo.companyName         
                            ])
                    </script>
                    <continue/>
                </if>
                <entity-find entity-name="mantle.party.PartyContent" list="contents">
                    <econdition field-name="partyId" from="userInfo.userPartyId"/>
                    <econdition field-name="partyContentTypeEnumId" 
                        from="userPartyId? 'PcntImageMedium' : 'PcntImageSmall'" />
                </entity-find>
                <if condition="contents">    
                    <service-call name="growerp.100.ImageServices100.download#Image"
                        in-map="[contentLocation: contents[0].contentLocation]" out-map="context"/></if>
                <!-- listing -->
                <set field="userOut" from="[
                    partyId: userInfo?.userPartyId,
                    email: userInfo?.emailAddress,
                    name: userInfo?.username,
                    firstName: userInfo?.firstName,
                    lastName: userInfo?.lastName,
                    userGroupId: userInfo.userGroupId,
                    groupDescription: userInfo?.description,
                    language: userInfo?.locale.toString(),
                    companyPartyId: userInfo.companyPartyId,
                    companyName: userInfo.companyName,
                    image: imageFile]"/>

                <if condition="!userPartyId">
                    <script>users.add(userOut)</script>
                    <else>
                        <!-- more info for single user -->
                        <set field="user1" from="[
                            userId: userInfo?.userId,
                            userGroupId: userInfo?.userGroupId,
                            locale: userInfo?.locale,
                            externalId: userInfo?.externalId]"/>
                        <set field="user" from="userOut"/>
                        <script>user.putAll(user1)</script>
                    </else>
                </if>
            </iterate>
            <!--if condition="users &amp;&amp; !userPartyId">
                <log message="====getusers=result: ${users.size()}"/>
                <script>users.sort{a, b -> 
                    a.lastName.compareToIgnoreCase(b.lastName) } </script>
                </if>
            <if condition="userPartyId">
                <log message="====single party: $user"/>
            </if-->
        </actions>
    </service>

    <service verb="create" noun="User">
        <description>
            add a new user on an existing owner company
        </description>
        <in-parameters>
            <parameter name="user"/>
        </in-parameters>
        <out-parameters>
            <parameter name="user"/>
        </out-parameters>
        <actions>
            <script> // convert JSON data
                Object userIn = new groovy.json.JsonSlurper().parseText(user).user
            </script>
            <if condition="userIn.userGroupId == 'GROWERP_M_EMPLOYEE' ||
                    userIn.userGroupId == 'GROWERP_M_ADMIN'">
                <set field="roleTypeId" value="Employee"/></if>
            <if condition="userIn.userGroupId == 'GROWERP_M_LEAD' ||
                    userIn.userGroupId == 'GROWERP_M_CUSTOMER'">
                <set field="roleTypeId" value="Customer"/></if>
            <if condition="userIn.userGroupId == 'GROWERP_M_SUPPLIER'">
                <set field="roleTypeId" value="Supplier"/></if>

            <service-call out-map="relComp"
                name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner"/>
            <service-call name="mantle.party.PartyServices.create#Account" 
                in-map="context + [roleTypeId: 'Employee', loginAfterCreate: false,
                        firstName: userIn.firstName, lastName: userIn.lastName,
                        emailAddress: userIn.email, disabled: 'N']"
                out-map="userAccount" />
            <set field="userPartyId" from="userAccount.partyId"/>
            <!-- update owner on userPartyId -->
            <entity-find-one entity-name="mantle.party.Party"
                    value-field="party" for-update="true">
                <field-map field-name="partyId" from="userPartyId"/>
            </entity-find-one>
            <set field="party.ownerPartyId" from="relComp.ownerPartyId"/>
            <entity-update value-field="party"/>
            <!-- no need to create company for employee and admin -->
            <if condition="userIn.userGroupId != 'GROWERP_M_ADMIN' &amp;&amp; 
                            userIn.userGroupId != 'GROWERP_M_EMPLOYEE'">
                <if condition="!userIn.companyName">
                    <return error="true"
                        message="Company name required for new lead, customer or supplier"/>
                </if>
                <service-call out-map="comp"
                    name="mantle.party.PartyServices.create#Organization"
                    in-map="[organizationName: userIn.companyName,
                            ownerPartyId: relComp.ownerPartyId,
                            disabled: 'N']"/>
                <set field="companyPartyId" from="comp.partyId"/>
                <else>
                    <set field="companyPartyId" from="relComp.ownerPartyId"/>
                </else>
            </if>
            <service-call name="create#mantle.party.PartyRelationship"
                in-map="[fromPartyId: userPartyId, fromRoleTypeId: 'Employee',
                    relationshipTypeEnumId: 'PrtEmployee', fromDate: ec.user.nowTimestamp,
                    toPartyId: companyPartyId, toRoleTypeId: roleTypeId]" />
            <service-call name="create#moqui.security.UserGroupMember"
                in-map="[userGroupId: userIn.userGroupId, userId: userAccount.userId]" />
            <service-call name="growerp.100.PartyServices100.get#User"
                in-map="[userPartyId: userPartyId]" out-map="context"/>
        </actions>
    </service>

    <service verb="update" noun="User">
        <description>
            update user information
        </description>
        <in-parameters>
            <parameter name="user"/>
            <parameter name="base64"/>
        </in-parameters>
        <out-parameters>
            <parameter name="user"/>
        </out-parameters>
        <actions>
            <script> // convert JSON data
                Object userIn = new groovy.json.JsonSlurper().parseText(user).user
            </script>
            <service-call name="growerp.100.PartyServices100.get#User"
                in-map="[userPartyId: userIn.partyId]" out-map="oldValue"/>
            <service-call name="update#mantle.party.Person" 
                in-map="[   partyId: userIn.partyId, 
                            firstName: userIn.firstName ? userIn.firstName : oldValue.user.firstName, 
                            lastName: userIn.lastName ? userIn.lastName : oldValue.user.lastName]"/>
            <service-call name="mantle.party.PartyServices.update#PartyUserAccount"
                in-map="[   partyId: userIn.partyId, 
                            emailAddress: userIn.email ? userIn.email : oldValue.user.email,
                            username: userIn.name? userIn.name : oldValue.user.name,
                            locale: language
                        ]"/>
            <!--update user group -->
            <if condition="!userIn.userGroupId">
                <return error="true" message="userGroupId not supplied to update user"/></if>
            <if condition="userIn.userGroupId != oldValue.user.userGroupId">
                <if condition="oldValue.user.userGroupid == 'GROWERP_M_ADMIN'">
                    <!-- check if only a single admin: cannot change -->
                    <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyPartyId" 
                        in-map="[userPartyId: userIn.partyId]" out-map="company"/>
                    <entity-find entity-name="growerp.mobile.CompanyPersonAndLoginGroup" list="admins">
                        <econdition field-name="userGroupId" value="GROWERP_M_ADMIN"/>
                        <econdition field-name="companyPartyId" from="company.partyId" />
                        <date-filter/></entity-find>
                    <if condition="admins.size() == 1">
                        <return error="true" message="You need at least a single Admin in your company: cannot remove this one!"/></if>
                </if>
                <entity-find entity-name="moqui.security.UserGroupMember" list="groupMembers" for-update="true">
                    <econdition field-name="userGroupId" from="oldValue.user.userGroupId"/>
                    <econdition field-name="userId" from="oldValue.user.userId"/>
                </entity-find>
                <set field="groupMembers[0].thruDate" from="ec.user.nowTimestamp"/>
                <entity-update value-field="groupMembers[0]"/>
                <service-call name="create#moqui.security.UserGroupMember"
                    in-map="[userGroupId: userIn.userGroupId, userId: oldValue.user.userId, fromDate: ec.user.nowTimestamp]"/>
            </if>    
            <!-- update external id for customer indentification -->
            <entity-find-one value-field="party" entity-name="mantle.party.Party" for-update="true">
                <field-map field-name="partyId" from="userIn.partyId"/></entity-find-one>
            <if condition="userIn.externalId != party.externalId">
                <set field="party.externalId" from="userIn.externalId"/>
                <entity-update value-field="party"/></if>
            <!-- update image -->
            <if condition="base64">
                <service-call name="growerp.100.ImageServices100.upload#Image"
                    in-map="[type: 'user', id: userIn.partyId, base64: base64]"/>
            </if>
            <!-- update company name for customer, lead supplier -->
            <if condition="userIn.userGroupId != 'GROWERP_M_ADMIN' &amp;&amp; 
                                    userIn.userGroupId != 'GROWERP_M_EMPLOYEE'">
                <entity-find-one value-field="party" entity-name="mantle.party.Organization"
                        for-update="true">
                    <field-map field-name="partyId" from="userIn.companyPartyId"/>
                </entity-find-one>
                <if condition="userIn.companyName != party.organizationName">
                    <set field="party.organizationName" from="userIn.companyName"/>
                    <entity-update value-field="party"/>
            </if></if>
            <!-- return updated user -->
            <service-call name="growerp.100.PartyServices100.get#User"
                in-map="[userPartyId: userIn.partyId]" out-map="context"/>
        </actions>
    </service>

    <service verb="delete" noun="User">
        <in-parameters>
            <parameter name="partyId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="partyId"/>
        </out-parameters>
        <actions>
            <!-- check if this user has an admin account -->
            <service-call name="growerp.100.PartyServices100.get#User"
                in-map="[userPartyId: partyId]" out-map="oldValue"/>
            <if condition="oldValue.user.userGroupid == 'GROWERP_M_ADMIN'">
                <!-- check if only a single admin: cannot change -->
                <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyPartyId" 
                    in-map="[userPartyId: partyId]" out-map="company"/>
                <entity-find entity-name="growerp.mobile.CompanyPersonAndLoginGroup" list="admins">
                    <econdition field-name="userGroupId" value="GROWERP_M_ADMIN"/>
                    <econdition field-name="companyPartyId" from="company.partyId" />
                    <date-filter/></entity-find>
                <if condition="admins.size() == 1">
                    <return error="true" message="You need at least a single Admin in your company: cannot delete this one!"/></if>
            </if>
            <service-call name="update#mantle.party.Party" in-map="[partyId: partyId, disabled: 'Y']"/>
        </actions>
    </service>

    <service verb="register" noun="UserAndCompany" authenticate="anonymous-all">
        <description>Register a new accounting/ownercompany with an admin user</description>
        <in-parameters>
            <!-- user information -->
            <parameter name="firstName" required="true" />
            <parameter name="middleName" />
            <parameter name="lastName" required="true" />
            <parameter name="emailAddress" required="true">
                <text-email />
            </parameter>
            <parameter name="username" default="emailAddress"/>
            <parameter name="newPassword" default="org.moqui.util.StringUtilities.getRandomString(6) + '9!'" />
            <parameter name="newPasswordVerify" default="newPassword" />
            <parameter name="locale" />
            <!-- company information -->
            <parameter name="companyName"/><!-- can be empty with new user existing company -->
            <parameter name="companyEmailAddress"/>
            <parameter name="currencyId"/>
            <parameter name="classificationId" required="true"/> <!-- allocate company to application name -->
            <!-- default setup -->
            <parameter name="environment"/>
        </in-parameters>
        <out-parameters>
            <parameter name="user" />
            <parameter name="company" />
        </out-parameters>
        <actions>
            <service-call name="mantle.party.PartyServices.create#Account" 
                in-map="context + [roleTypeId: 'Employee',
                        loginAfterCreate: false, disabled: 'N']"
                out-map="userAccount" />
            <set field="userPartyId" from="userAccount.partyId"/>
            <set field="fromDate" from="ec.user.nowTimestamp"/>
            <if condition="userAccount.partyId != null">
                <!-- add the user as admin -->
                <service-call name="create#moqui.security.UserGroupMember"
                    in-map="[userGroupId: 'GROWERP_M_ADMIN', userId: userAccount.userId]"/>
                <!-- create company -->
                <service-call name="mantle.party.PartyServices.create#Organization"
                    in-map="[roleTypeId: 'OrgInternal',organizationName: companyName,
                            disabled: 'N']" out-map="company" />
                <set field="companyPartyId" from="company.partyId" />
                <!-- company email address -->
                <service-call name="mantle.party.ContactServices.create#EmailAddress" 
                    in-map="[emailAddress: companyEmailAddress, partyId: companyPartyId,
                        contactMechPurposeId:'EmailPrimary']" out-map="emailOut"/>
                <!-- initialize accounting with defaults -->
                <service-call name="mantle.ledger.LedgerServices.init#PartyAccountingConfiguration"
                    in-map="[sourcePartyId: 'DefaultSettings',
                            organizationPartyId: companyPartyId, baseCurrencyUomId: currencyId]" />
                <!-- set classification: admin hotel, ecommerce etc -->
                <service-call name="create#mantle.party.PartyClassificationAppl"
                    in-map="[partyId: companyPartyId, partyClassificationId: classificationId]"
                    out-map="context" />
                <!-- create productStore -->
                <service-call name="create#mantle.product.store.ProductStore"
                    out-map="context" in-map="[organizationPartyId: companyPartyId,
                        requireInventory: 'N',
                        reservationOrderEnumId:'AsResOrdNoRes',
                        defaultCurrencyUomId: currencyId]" />
                <!-- create root category -->
                <service-call name="create#mantle.product.category.ProductCategory" out-map="context" 
                    in-map="[ownerPartyId: companyPartyId, productCategoryTypeEnumId: 'PctRoot',
                        categoryName: 'Root category for: ' + classificationId]" />
                <!-- connect to productstore -->
                <service-call name="create#mantle.product.store.ProductStoreCategory" 
                    in-map="[productCategoryId: productCategoryId,
                        storeCategoryTypeEnumId: 'PsctBrowseRoot',
                        productStoreId: productStoreId, fromDate: fromDate]" />
                <!-- set company in as ACTIVE_ORGANIZATION UserPreference -->
                <service-call name="create#moqui.security.UserPreference"
                    in-map="[userId: userAccount.userId, preferenceKey: 'ACTIVE_ORGANIZATION',
                     preferenceValue: companyPartyId]" />
                <!--send email -->
                <service-call name="org.moqui.impl.EmailServices.send#EmailTemplate" async="true">
                    <field-map field-name="emailTemplateId" value="WELCOME" />
                    <field-map field-name="toAddresses" from="emailAddress" />
                    <field-map field-name="bodyParameters" 
                        from="[classification: partyClassificationId.substring(3),
                            newPassword:newPassword]" />
                </service-call>
                <!-- attach the user as an employee to the organization-->
                <service-call name="create#mantle.party.PartyRelationship"
                    in-map="[fromPartyId: userPartyId, fromRoleTypeId: 'Employee',
                        relationshipTypeEnumId: 'PrtEmployee', fromDate: fromDate,
                        toPartyId: companyPartyId, toRoleTypeId: 'OrgInternal']" />
                <!-- set party ownership -->
                <entity-find-one entity-name="mantle.party.Party" value-field="userParty"
                        for-update="true">
                    <field-map field-name="partyId" from="userPartyId"/></entity-find-one>
                <set field="userParty.ownerPartyId" from="companyPartyId"/>
                <entity-update value-field="userParty"/>
                <!-- set company ownership (Own itself)-->
                <entity-find-one entity-name="mantle.party.Party"
                        value-field="companyParty" for-update="true">
                    <field-map field-name="partyId" from="companyPartyId"/></entity-find-one>
                <set field="companyParty.ownerPartyId" from="companyPartyId"/>
                <entity-update value-field="companyParty"/>
                <!-- load demo data -->
                <script>ec.user.loginUser(username, newPassword)</script>
                <service-call name="growerp.100.PartyServices100.load#DefaultData"
                    include-user-login="true"  async="true"
                    in-map="[companyPartyId: companyPartyId,
                             currencyId: currencyId,
                             classificationId: classificationId,
                             userPartyId: userAccount.partyId]"/>
                <!-- return company Data -->
                <service-call name="growerp.100.PartyServices100.get#Company"
                    out-map="context"/>
                <!-- retrn user data -->
                <service-call name="growerp.100.PartyServices100.get#User"
                    in-map="userPartyId: userPartyId" out-map="context"/>
                </if>
        </actions>
    </service>
    <!--internal service used in register to run async-->
    <service verb="load" noun="DefaultData" authenticate="anonymous-all" transaction-timeout="3600">
        <!-- not reachable outside -->
        <in-parameters>
            <parameter name="companyPartyId" required="true"/>
            <parameter name="userPartyId" required="true"/>
            <parameter name="currencyId"/>
            <parameter name="classificationId"/>
            <parameter name="counter" default="5" type="Integer"/>
        </in-parameters>
        <actions>
            <log message="Loading demo data #$counter sets for user: $userPartyId company: $companyPartyId"/>
            <script>sleep(2000)</script><!-- wait for registration bove to commit -->
            <entity-find entity-name="mantle.product.category.ProductCategory" list="rootList">
                <econdition field-name="productCategoryTypeEnumId" value="PctRoot"/>
                <econdition field-name="ownerPartyId" from="companyPartyId"/></entity-find>
            <if condition="!rootList">
                <return error="true" message="Root category not found for companyId: $companyPartyId"/></if>
            <set field="rootProductCategoryId" from="rootList[0].productCategoryId"/>

            <!-- structure of data, image should be in dbresource://GrowERP/images/...Medium.jpg-->
            <!-- format of the data should be in the catalog format: 
                https://github.com/growerp/growerp/blob/packages/models/lib/catalog.dart -->
            <set field="product1" from="[ productName: 'cola', description:'description', price: 34, image: 'cola']"/>    
            <set field="product2" from="[ productName: 'wiskey', description:'description', price: 31, image: 'wiskey']"/>    
            <set field="products1" from="[ product1, product2]"/>
            <set field="category1" from="[categoryName: 'drinks', image: 'drinks', image: 'drinks', 
                                        products: products1]"/>    
            <set field="product3" from="[ productName: 'macaroni', description:'description',
                                        price: 12, image: 'macaroni']"/>    
            <set field="product4" from="[ productName: 'hamburger', description:'description', price: 33, image: 'hamburger']"/>    
            <set field="products2" from="[ product3, product4]"/>
            <set field="category2" from="[categoryName: 'food', image: 'drinks', image: 'food',
                                        products: products2]"/>    
            <set field="categories" from="[category1, category2]"/>    

            <set field="users" from=
            "[
                [ firstName: 'Jan', lastName: 'Admin1', emailAddress: 'jan1@example.com',
                locale: 'EN', username: 'jan1', externalId: 'ext',
                userGroupId: 'GROWERP_M_ADMIN' ],
                [ firstName: 'Jan', lastName: 'Employee1', emailAddress: 'jan2@example.com',
                    locale: 'EN', username: 'jan2', externalId: 'ext',
                    userGroupId: 'GROWERP_M_EMPLOYEE' ],
                [ firstName: 'Jan', lastName: 'Customer1', emailAddress: 'jan3@example.com',
                    locale: 'EN', username: 'jan3', externalId: 'ext',
                    userGroupId: 'GROWERP_M_CUSTOMER', companyName: 'Customer org1'],
                [ firstName: 'Jan', lastName: 'lead1', emailAddress: 'jan4@example.com',
                    locale: 'EN', username: 'jan4', externalId: 'ext',
                    userGroupId: 'GROWERP_M_LEAD',  companyName: 'Lead org1'],
                [ firstName: 'Jan', lastName: 'Supplier1', emailAddress: 'jan5@example.com',
                    locale: 'EN', username: 'jan5', externalId: 'ext',
                    userGroupId: 'GROWERP_M_SUPPLIER', companyName: 'Supplier org1'],
                [ firstName: 'Jan', lastName: 'Admin2', emailAddress: 'jan11@example.com',
                    locale: 'EN', username: 'jan11', externalId: 'ext',
                    userGroupId: 'GROWERP_M_ADMIN'],
                [ firstName: 'Jan', lastName: 'Employee2', emailAddress: 'jan12@example.com',
                    locale: 'EN', username: 'jan12', externalId: 'ext',
                    userGroupId: 'GROWERP_M_EMPLOYEE' ],
                [ firstName: 'Jan', lastName: 'Customer2', emailAddress: 'jan13@example.com',
                    locale: 'EN', username: 'jan13', externalId: 'ext',
                    userGroupId: 'GROWERP_M_CUSTOMER' , companyName: 'Customer org2'],
                [ firstName: 'Jan', lastName: 'lead2', emailAddress: 'jan14@example.com',
                    locale: 'EN', username: 'jan14', externalId: 'ext',
                    userGroupId: 'GROWERP_M_LEAD' , companyName: 'Lead org2'],
                [ firstName: 'Jan', lastName: 'Supplier2', emailAddress: 'jan15@example.com',
                    locale: 'EN', username: 'jan15', externalId: 'ext',
                    userGroupId: 'GROWERP_M_SUPPLIER' , companyName: 'Supplier org2'],
            ]"/>

            <set field="opportunities" from="
            [
                [ opportunityName: 'The best opportunity', description: 'the best oppr description',
                    nextStep: 'not sure yet', estimatedAmount: 1000, estimatedProbability: 33,
                    opportunityStageId: 'Prospecting'],
                [ opportunityName: 'The second best opportunity', description: 'the secondbest oppr description',
                    nextStep: 'not sure yet', estimatedAmount: 5000, estimatedProbability: 66,
                    opportunityStageId: 'Proposal']
            ]"/>

            <set field="orderItem1" from="[ quantity: 5, price: 22.1]"/>    
            <set field="orderItem2" from="[ quantity: 9, price: 33.4]"/>    
            <set field="orderItems1" from="[ orderItem1, orderItem2]"/>
            <set field="order1" from="[ orderItems: orderItems1 ]"/>
            <set field="orderItem3" from="[ quantity: 3, price: 12.1]"/>    
            <set field="orderItem4" from="[ quantity: 2, price: 13.4]"/>    
            <set field="orderItems2" from="[ orderItem1, orderItem2]"/>
            <set field="order2" from="[ orderItems: orderItems2 ]"/> 
            <set field="orders" from="[order1, order2]"/>

            <set field="nowDate" from="ec.user.nowTimestamp"/>
            <while condition="counter--">
                <iterate list="categories" entry="el">
                    <service-call name="create#mantle.product.category.ProductCategory"
                        in-map="[categoryName: counter.toString() + el.categoryName,
                                description: el.description,
                                productCategoryTypeEnumId: 'PctCatalog',
                                ownerPartyId: companyPartyId]"
                        out-map="context"/>
                    <service-call 
                        name="create#mantle.product.category.ProductCategoryRollup"
                        in-map="[parentProductCategoryId: rootProductCategoryId,
                                productCategoryId: productCategoryId]"/>
                    <service-call name="create#ProductCategoryContent" in-map="[
                        productCategoryId: productCategoryId,
                        categoryContentTypeEnumId: 'PcctImageThumbNail',
                        contentLocation: 'dbresource://GrowERP/images/' +
                            el.image + 'Small.png']" />
                    <service-call name="create#ProductCategoryContent" in-map="[
                        productCategoryId: productCategoryId,
                        categoryContentTypeEnumId: 'PcctImageMedium',
                        contentLocation: 'dbresource://GrowERP/images/' +
                            el.image + 'Medium.png']" />
                    <set field="index" type="Integer" value="0"/>
                    <iterate list="el.products" entry="product">
                        <service-call name="create#mantle.product.Product" in-map="[
                            productName: counter.toString() + product.productName,
                            description: product.description,
                            ownerPartyId: companyPartyId,
                            productTypeEnumId: 'PtAsset',
                            assetTypeEnumId: 'AstTpInventory',
                            assetClassEnumId: 'AsClsInventoryFin']" out-map="context" />
                        <if condition="index == 0">
                            <set field="product1" from="productId"/>
                        </if>
                        <if condition="index == 1">
                            <set field="product2" from="productId"/>
                        </if>
                        <service-call
                            name="create#mantle.product.category.ProductCategoryMember"
                            in-map="[productId: productId, productCategoryId: productCategoryId, fromDate: fromDate]"/>
                        <service-call name="create#mantle.product.ProductPrice"
                            in-map="[productId: productId, priceTypeEnumId: 'PptList',
                            priceUomId: currencyId, price: product.price,
                            fromDate: ec.user.nowTimestamp,
                            pricePurposeEnumId: 'PppPurchase']"/>
                        <service-call name="create#ProductContent" in-map="[
                            productId: productId,
                            productContentTypeEnumId: 'PcntImageSmall',
                            contentLocation: 'dbresource://GrowERP/images/' +
                                product.image + 'Small.png']" />
                        <service-call name="create#ProductContent" in-map="[
                            productId: productId,
                            productContentTypeEnumId: 'PcntImageMedium',
                            contentLocation: 'dbresource://GrowERP/images/' +
                            product.image + 'Medium.png']" />
                        <set field="index" from="index + 1"/>
                    </iterate>
                </iterate>
                <set field="index" type="Integer" value="0"/>
                <iterate list="users" entry="us">
                    <set field="userIn" from="groovy.json.JsonOutput.toJson([user:[
                        firstName: us.firstName,
                        lastName: counter.toString() + us.lastName,
                        email: companyPartyId + counter.toString() + us.emailAddress,
                        locale: 'EN',
                        username: companyPartyId + counter.toString() + us.username,
                        externalId: us.externalid,
                        userGroupId: us.userGroupId, companyName: us.companyName
                    ]])"/>
                    <service-call name="growerp.100.PartyServices100.create#User"
                            in-map="[user: userIn]" out-map="context"/>
                    <if condition="user.userGroupId == 'GROWERP_M_LEAD'">
                        <if condition="index%2 == 0">
                            <set field="leadCompany1" from="user.companyPartyId"/>
                            <set field="leadUser1" from="user.partyId"/>
                        </if>
                        <if condition="index%2 == 1">
                            <set field="leadCompany2" from="user.companyPartyId"/>
                            <set field="leadUser2" from="user.partyId"/>
                        </if>
                    </if>
                    <if condition="user.userGroupId == 'GROWERP_M_CUSTOMER'">
                        <if condition="index%2 == 0">
                            <set field="customerCompany1" from="user.companyPartyId"/>
                            <set field="customerUser1" from="user.partyId"/>
                        </if>
                        <if condition="index%2 == 1">
                            <set field="customerCompany2" from="user.companyPartyId"/>
                            <set field="customerUser2" from="user.partyId"/>
                        </if>
                    </if>
                    <if condition="user.userGroupId == 'GROWERP_M_SUPPLIER'">
                        <if condition="index%2 == 0">
                            <set field="supplierCompany1" from="user.companyPartyId"/>
                            <set field="supplierUser1" from="user.partyId"/>
                        </if>
                        <if condition="index%2 == 1">
                            <set field="supplierCompany2" from="user.companyPartyId"/>
                            <set field="supplierUser2" from="user.partyId"/>
                        </if>
                    </if>
                    <if condition="user.userGroupId == 'GROWERP_M_EMPLOYEE'">
                        <if condition="index%2 == 0">
                                <set field="employeeCompany1" from="user.companyPartyId"/>
                                <set field="employeeUser1" from="user.partyId"/>
                        </if>
                        <if condition="index%2 == 1">
                            <set field="employeeCompany2" from="user.companyPartyId"/>
                            <set field="employeeUser2" from="user.partyId"/>
                        </if>
                    </if>
                    <set field="index" from="index + 1"/>
                </iterate>
                <set field="index" type="Integer" value="0"/>
                <iterate list="opportunities" entry="opp">
                    <set field="oppIn" from="groovy.json.JsonOutput.toJson([opportunity:[
                        opportunityName: opp.opportunityName,
                        description: opp.description,
                        nextStep: opp.nextStep,
                        estimatedAmount: opp.estimatedAmount,
                        estimatedProbability: opp.estimatedProbability,
                        opportunityStageId: opp.opportunityStageId,
                        ownerPartyId: companyPartyId,
                        accountPartyId: index%2 == 0? userPartyId: employeeUser1,
                        leadPartyId: index%2 == 0 ? leadUser1 : leadUser2
                    ]])"/>
                    <service-call name="growerp.100.CrmServices100.create#Opportunity"
                                    in-map="[opportunity: oppIn]" out-map="context"/>
                    <set field="index" from="index + 1"/>
                </iterate>

                <set field="index" type="Integer" value="0"/>
                <iterate list="orders" entry="order">
                    <entity-find entity-name="mantle.product.store.ProductStore" list="stores">
                        <econdition field-name="organizationPartyId" from="companyPartyId"/>
                    </entity-find>
                    <entity-find-one entity-name="mantle.ledger.config.PartyAcctgPreference"
                            value-field="aPref">
                        <field-map field-name="organizationPartyId" from="companyPartyId"/>
                    </entity-find-one>
                    <service-call name="mantle.order.OrderServices.create#Order"
                        in-map="[
                            currencyUomId: aPref.baseCurrencyUomId,
                            productStoreId: stores[0].productStoreId,
                            placedDate: ec.user.nowTimestamp,
                            customerPartyId: index%2 == 0 ? companyPartyId : customerCompany2 ,
                            vendorPartyId: index%2 == 0 ? supplierCompany2 : companyPartyId
                        ]" out-map="context"/>
                    <iterate entry="item" list="order.orderItems">
                        <service-call
                            name="mantle.order.OrderServices.add#OrderProductQuantity"
                            in-map="context + [productId: index==1 ? product1 : product2,
                                                quantity: item.quantity,
                                                unitAmount: item.price,
                                                currencyUomId: aPref.baseCurrencyUomId]"
                            out-map="itemcreate"/>
                    </iterate>
                    <service-call name="growerp.100.OrderServices100.getOrders"
                        in-map="[orderId: orderId]" out-map="context"/>
                    <set field="index" from="index + 1"/>
                </iterate>

            </while>
            <!--if condition="environment != 'production'"-->
        </actions>
    </service>

</services>